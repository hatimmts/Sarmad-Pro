<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sarmad Admin | التحكم والرقابة</title>
    <style>
        :root { --green: #00ff88; --bg: #000; }
        body { background: var(--bg); color: #fff; font-family: sans-serif; margin: 0; padding: 15px; }
        .card { background: #0a0a0a; border: 1px solid #222; padding: 20px; border-radius: 15px; margin-bottom: 15px; }
        input, select { background: #000; border: 1px solid #333; color: #fff; padding: 10px; border-radius: 5px; width: 100%; margin: 10px 0; }
        .btn { width: 100%; padding: 12px; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; margin-top: 5px; }
        .btn-go { background: var(--green); color: #000; }
        .btn-rej { background: #ff4444; color: #fff; }
        .txid-box { background: #111; color: var(--green); padding: 10px; border-radius: 5px; font-family: monospace; cursor: pointer; border: 1px dashed var(--green); display: block; margin: 10px 0; text-align: center; }
        .hidden { display: none; }
        table { width: 100%; border-collapse: collapse; font-size: 0.8rem; }
        th, td { border: 1px solid #222; padding: 8px; text-align: center; }
    </style>
</head>
<body>

<div id="auth-ui" class="card" style="max-width:400px; margin: 50px auto;">
    <h2 style="color:var(--green); text-align:center;">دخول الإدارة</h2>
    <div id="step-1">
        <input type="tel" id="admin-phone" placeholder="+962xxxxxxxxx">
        <button class="btn btn-go" onclick="checkAdmin()">تحقق من الصلاحية</button>
    </div>
    <div id="step-2" class="hidden">
        <div id="recaptcha-container"></div>
        <input type="text" id="admin-otp" placeholder="رمز OTP">
        <button class="btn btn-go" onclick="verifyAdminOTP()">دخول النظام</button>
    </div>
    <p id="auth-msg" style="color:red; text-align:center;"></p>
</div>

<div id="dashboard" class="hidden">
    <div id="owner-panel" class="card hidden">
        <h3 style="color:var(--green)">إدارة المحاسبين</h3>
        <div id="staff-list"></div>
    </div>

    <h3 style="color:var(--green)">طلبات الشراء القادمة (Pending)</h3>
    <div id="pending-list"></div>
</div>

<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyBVyEPs_xvz9Oryk-jpLev4ja7Sb1P6RaM",
        authDomain: "sarmad-web.firebaseapp.com",
        projectId: "sarmad-web",
        storageBucket: "sarmad-web.firebasestorage.app",
        messagingSenderId: "687271413195",
        appId: "1:687271413195:web:f9564027c56ed0efb7e24e"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    async function checkAdmin() {
        const p = document.getElementById('admin-phone').value;
        const adminDoc = await db.collection('admins').doc(p).get();
        if (adminDoc.exists && adminDoc.data().active) {
            document.getElementById('step-1').classList.add('hidden');
            document.getElementById('step-2').classList.remove('hidden');
            window.recaptchaVerifier = new firebase.auth.RecaptchaVerifier('recaptcha-container', {size:'invisible'});
            auth.signInWithPhoneNumber(p, window.recaptchaVerifier).then(res => window.confirmationResult = res);
        } else {
            document.getElementById('auth-msg').innerText = "ليس لديك صلاحية";
        }
    }

    function verifyAdminOTP() {
        const c = document.getElementById('admin-otp').value;
        window.confirmationResult.confirm(c).then(() => location.reload());
    }

    auth.onAuthStateChanged(async user => {
        if (user) {
            document.getElementById('auth-ui').classList.add('hidden');
            document.getElementById('dashboard').classList.remove('hidden');
            const myData = (await db.collection('admins').doc(user.phoneNumber).get()).data();
            if (myData.role === 'owner') {
                document.getElementById('owner-panel').classList.remove('hidden');
                initStaffManager();
            }
            initRequestsManager(myData);
        }
    });

    function initRequestsManager(myData) {
        db.collection('investors').onSnapshot(snap => {
            const list = document.getElementById('pending-list');
            list.innerHTML = '';
            snap.forEach(doc => {
                const inv = doc.data();
                const requests = inv.requests || [];
                requests.forEach((req, idx) => {
                    if (req.status === 'pending') {
                        list.innerHTML += `
                        <div class="card">
                            <small>المستثمر: ${doc.id}</small>
                            <span class="txid-box" onclick="copyTX('${req.txid}')">${req.txid}</span>
                            <input type="number" id="amt-${doc.id}-${idx}" placeholder="أدخل مبلغ الرصيد">
                            <button class="btn btn-go" onclick="approveReq('${doc.id}', ${idx})">تفعيل الرصيد ✅</button>
                            <button class="btn btn-rej" onclick="rejectReq('${doc.id}', ${idx})">رفض الطلب ❌</button>
                        </div>`;
                    }
                });
            });
        }, err => {
            document.getElementById('pending-list').innerHTML = "<p style='color:orange'>بانتظار موافقة المدير العام على دخولك...</p>";
        });
    }

    function copyTX(t) {
        navigator.clipboard.writeText(t).then(() => alert('تم النسخ: ' + t));
    }

    async function approveReq(phone, idx) {
        const amt = document.getElementById(`amt-${phone}-${idx}`).value;
        if(!amt) return alert('أدخل المبلغ');
        const ref = db.collection('investors').doc(phone);
        const doc = await ref.get();
        let reqs = doc.data().requests;
        reqs[idx].status = 'approved';
        await ref.update({
            balance: (doc.data().balance || 0) + parseFloat(amt),
            requests: reqs
        });
        alert('تم الاعتماد');
    }

    async function rejectReq(phone, idx) {
        const reason = prompt('سبب الرفض:');
        if(!reason) return;
        const ref = db.collection('investors').doc(phone);
        const doc = await ref.get();
        let reqs = doc.data().requests;
        reqs[idx].status = 'rejected';
        reqs[idx].reason = reason;
        await ref.update({ requests: reqs });
        alert('تم الرفض');
    }

    function initStaffManager() {
        db.collection('admins').where('role','==','staff').onSnapshot(snap => {
            let h = '<table><tr><th>المحاسب</th><th>الحالة</th><th>إجراء</th></tr>';
            snap.forEach(doc => {
                const s = doc.data();
                h += `<tr><td>${doc.id}</td><td>${s.isApprovedByOwner?'نشط':'معلق'}</td>
                <td><button onclick="toggleS('${doc.id}', ${!s.isApprovedByOwner})">${s.isApprovedByOwner?'إيقاف':'تفعيل'}</button></td></tr>`;
            });
            document.getElementById('staff-list').innerHTML = h + '</table>';
        });
    }
    function toggleS(id, st) { db.collection('admins').doc(id).update({isApprovedByOwner: st}); }
</script>
</body>
</html>

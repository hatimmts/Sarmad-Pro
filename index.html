<script>
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

auth.onAuthStateChanged(async user => {
  if (!user) return;

  const adminSnap = await db.collection('admins').doc(user.phoneNumber).get();
  if (!adminSnap.exists) return alert('غير مصرح');

  initRequests();
});

function initRequests() {
  db.collection('purchase_requests')
    .where('status','==','pending')
    .onSnapshot(snap => {
      const list = document.getElementById('pending-list');
      list.innerHTML = '';
      snap.forEach(doc => {
        const r = doc.data();
        list.innerHTML += `
          <div class="card">
            <small>${r.investorPhone}</small>
            <span class="txid-box">${r.txid}</span>
            <input id="amt-${doc.id}" type="number" placeholder="المبلغ">
            <button class="btn btn-go" onclick="approve('${doc.id}')">اعتماد</button>
            <button class="btn btn-rej" onclick="reject('${doc.id}')">رفض</button>
          </div>
        `;
      });
    });
}

async function approve(id) {
  const amt = parseFloat(document.getElementById(`amt-${id}`).value);
  if (!amt) return alert('أدخل المبلغ');

  const reqRef = db.collection('purchase_requests').doc(id);

  await db.runTransaction(async t => {
    const reqSnap = await t.get(reqRef);
    if (reqSnap.data().status !== 'pending') throw 'تمت المعالجة سابقًا';

    const invRef = db.collection('investors').doc(reqSnap.data().investorPhone);
    const invSnap = await t.get(invRef);

    t.update(invRef, {
      balance: (invSnap.data().balance || 0) + amt
    });

    t.update(reqRef, {
      status: 'approved',
      approvedBy: auth.currentUser.phoneNumber,
      approvedAt: firebase.firestore.FieldValue.serverTimestamp()
    });

    t.set(db.collection('audit_logs').doc(), {
      action: 'approve',
      requestId: id,
      amount: amt,
      by: auth.currentUser.phoneNumber,
      time: firebase.firestore.FieldValue.serverTimestamp()
    });
  });

  alert('تم الاعتماد');
}

async function reject(id) {
  const reason = prompt('سبب الرفض');
  if (!reason) return;

  await db.collection('purchase_requests').doc(id).update({
    status: 'rejected',
    reason,
    rejectedBy: auth.currentUser.phoneNumber,
    rejectedAt: firebase.firestore.FieldValue.serverTimestamp()
  });

  await db.collection('audit_logs').add({
    action: 'reject',
    requestId: id,
    reason,
    by: auth.currentUser.phoneNumber,
    time: firebase.firestore.FieldValue.serverTimestamp()
  });

  alert('تم الرفض');
}
</script>
